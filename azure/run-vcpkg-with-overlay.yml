#
# Author: github.com/luncliff (luncliff@gmail.com)
#
# References
#   https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=azure-devops#step-reuse
#   https://github.com/microsoft/vcpkg/releases/tag/2021.05.12
#   https://github.com/microsoft/vcpkg/blob/2021.05.12/docs/users/config-environment.md
#

parameters:
  - name: port
    type: string
  - name: triplet
    type: string

steps:
  - task: run-vcpkg@0
    displayName: "${{ parameters.triplet }}: ${{ parameters.port }}"
    inputs:
      vcpkgGitCommitId: "2a31089e777fc187f1cc05338250b8e1810cfb52" # mainstream 2021-10-02
      vcpkgArguments: "${{ parameters.port }}" # vcpkg install ${port} ...
    env:
      VCPKG_DEFAULT_TRIPLET: ${{ parameters.triplet }} # --triplet ${triplet}
      VCPKG_OVERLAY_PORTS: $(Build.SourcesDirectory)/ports # --overlay-ports $(Build.SourcesDirectory)/ports
      # VCPKG_OVERLAY_TRIPLETS: $(Build.SourcesDirectory)/triplets # --overlay-triplets $(Build.SourcesDirectory)/triplets
      ANDROID_NDK_HOME: $(ANDROID_NDK_LATEST_HOME)
  - task: CopyFiles@2
    inputs:
      SourceFolder: "$(Build.BinariesDirectory)/vcpkg/buildtrees/${{ parameters.port }}" # check how https://github.com/lukka/CppBuildTasks works
      Contents: |
        ?(*.log|*.txt)
        *.cmake
      TargetFolder: "$(Build.ArtifactStagingDirectory)"
      OverWrite: true
    condition: failed()
  # - task: DeleteFiles@1
  #   inputs:
  #     SourceFolder: "$(Build.BinariesDirectory)/vcpkg/downloads"
  #     Contents: "**/*" # todo: change to downloads, buildtrees, etc.
  #     RemoveSourceFolder: true
  #     RemoveDotFiles: true
